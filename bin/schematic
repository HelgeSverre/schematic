#!/usr/bin/env php
<?php
use yii\console\controllers\HelpController;
use pahanini\log\ConsoleTarget;
use NerdsAndCompany\Schematic\Services\Schematic;
use NerdsAndCompany\Schematic\ConsoleCommands\ImportCommand;
use NerdsAndCompany\Schematic\ConsoleCommands\ExportCommand;

// Set path constants
define('CRAFT_BASE_PATH', getenv('CRAFT_BASE_PATH') ?: getcwd());
define('CRAFT_VENDOR_PATH', getenv('CRAFT_VENDOR_PATH') ?: CRAFT_BASE_PATH.'/vendor');
define('CRAFT_ENVIRONMENT', getenv('CRAFT_ENVIRONMENT') ?: 'production');

// Load Composer's autoloader
require_once CRAFT_VENDOR_PATH.'/autoload.php';

// Load and run Craft
$app = require_once CRAFT_VENDOR_PATH.'/craftcms/cms/bootstrap/console.php';

// Set console logger
$consoleTarget = new ConsoleTarget();
$consoleTarget->categories = ['schematic'];
Craft::getLogger()->dispatcher->targets[] = $consoleTarget;

// Add schematic controllers
$app->controllerMap = [
  'import' => ImportCommand::class,
  'export' => ExportCommand::class,
];

// Add schematic components
$components = [
  'schematic' => [
      'class' => Schematic::class,
  ],
];

foreach (Schematic::DATA_TYPES as $dataType) {
    $components['schematic_'.$dataType] = [
        'class' => 'NerdsAndCompany\\Schematic\\Services\\'.ucfirst($dataType),
    ];
}

$app->setComponents($components);
$app->init();
$exitCode = $app->run();
exit($exitCode);
