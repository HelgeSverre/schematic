#!/usr/bin/env php
<?php
use craft\migrations\Install;
use craft\models\Site;
use pahanini\log\ConsoleTarget;
use yii\console\controllers\HelpController;
use NerdsAndCompany\Schematic\Schematic;
use NerdsAndCompany\Schematic\ConsoleCommands\ImportCommand;
use NerdsAndCompany\Schematic\ConsoleCommands\ExportCommand;

// Set path constants
define('CRAFT_BASE_PATH', getenv('CRAFT_BASE_PATH') ?: getcwd());
define('CRAFT_VENDOR_PATH', getenv('CRAFT_VENDOR_PATH') ?: CRAFT_BASE_PATH.'/vendor');
define('CRAFT_ENVIRONMENT', getenv('CRAFT_ENVIRONMENT') ?: 'production');

// Load Composer's autoloader
require_once CRAFT_VENDOR_PATH.'/autoload.php';

// Load and run Craft
$app = require_once CRAFT_VENDOR_PATH.'/craftcms/cms/bootstrap/console.php';

// Set console logger
$consoleTarget = new ConsoleTarget();
$consoleTarget->categories = ['schematic'];
Craft::getLogger()->dispatcher->targets[] = $consoleTarget;

// Add schematic controllers
$app->controllerMap = [
  'import' => ImportCommand::class,
  'export' => ExportCommand::class,
];

// Add schematic components
$components = [];
foreach (Schematic::DATA_TYPES as $dataType => $componentClass) {
    $components['schematic_'.$dataType] = [
        'class' => $componentClass,
    ];
}

$app->setComponents($components);
$app->init();

// Install Craft if needed
if (!$app->getIsInstalled()) {
    Craft::info('Craft is not installed, installing', 'schematic');

    if (!getenv('CRAFT_EMAIL') || !getenv('CRAFT_PASSWORD')) {
        Craft::error('Please supply CRAFT_EMAIL and CRAFT_PASSWORD environment variables for install', 'schematic');
    }

    $site = new Site([
        'name' => getenv('CRAFT_SITENAME') ?: 'default',
        'handle' => 'default',
        'hasUrls' => true,
        'baseUrl' => getenv('CRAFT_SITEURL') ?: '@web',
        'language' => getenv('CRAFT_LOCALE') ?: 'en-US',
    ]);

    $migration = new Install([
        'username' => getenv('CRAFT_USERNAME') ?: 'admin',
        'password' => getenv('CRAFT_PASSWORD'),
        'email' => getenv('CRAFT_EMAIL'),
        'site' => $site,
    ]);

    // Run the install migration
    Craft::info('Installing Craft', 'schematic');
    $migrator = Craft::$app->getMigrator();
    $result = $migrator->migrateUp($migration);

    if ($result === false) {
        Craft::error('Failed to install Craft', 'schematic');
        exit(1);
    }
    Craft::info('Craft has been installed', 'schematic');
} else {
    Craft::info('Craft is installed, continueing', 'schematic');
}

$exitCode = $app->run();
exit($exitCode);
